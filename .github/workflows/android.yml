name: Android CI

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'  # åŒ¹é…ä»¥vå¼€å¤´çš„tagï¼Œå¦‚v1.0.0
  pull_request:
    branches: [ main, develop ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Run Unit Tests
      run: ./gradlew test --stacktrace

    - name: Generate Test Report
      run: ./gradlew jacocoTestDebugUnitTestReport
      continue-on-error: true



    # å¯é€‰ï¼šå¦‚æœä½ è®¾ç½®äº†Codecov tokenï¼Œå¯ä»¥å–æ¶ˆæ³¨é‡Šä¸‹é¢çš„æ­¥éª¤
    # - name: Upload Report to Codecov
    #   uses: codecov/codecov-action@v3
    #   with:
    #     token: ${{ secrets.CODECOV_TOKEN }}
    #     file: ./app/build/reports/jacoco/jacocoTestDebugUnitTestReport/jacocoTestDebugUnitTestReport.xml
    #     flags: unittests

  # GitHub Release Job - åªåœ¨æ¨é€vå¼€å¤´çš„tagæ—¶è¿è¡Œ
  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build-and-test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Build Release APK
      run: ./gradlew assembleRelease

    - name: Get tag name
      id: tag_name
      run: echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Rename APK file
      run: |
        cp app/build/outputs/apk/release/app-release.apk AndroidProxyToggle.apk

    - name: Create Release and Upload APK
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag_name.outputs.TAG_NAME }}
        name: Release ${{ steps.tag_name.outputs.TAG_NAME }}
        body: |
          ğŸš€ Android Proxy Toggle ${{ steps.tag_name.outputs.TAG_NAME }}
          
          ## ğŸ“± ä¸‹è½½APK
          è¯·ä¸‹è½½ä¸‹æ–¹çš„APKæ–‡ä»¶è¿›è¡Œå®‰è£…
          
          ## ğŸ”„ æ›´æ–°å†…å®¹
          - æ›´æ–°åˆ°ç‰ˆæœ¬ ${{ steps.tag_name.outputs.TAG_NAME }}
          
          ## ğŸ“ è¯´æ˜
          è¿™æ˜¯ä¸€ä¸ªAndroidä»£ç†åˆ‡æ¢åº”ç”¨çš„å‘å¸ƒç‰ˆæœ¬
        draft: false
        prerelease: false
        files: |
          AndroidProxyToggle.apk
