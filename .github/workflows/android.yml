name: Android CI

on:
  push:
    tags:
      - 'v*'  # åªåœ¨æ¨é€vå¼€å¤´çš„tagæ—¶è¿è¡Œ
  pull_request:
    branches: [ main, develop ]

# æ·»åŠ æƒé™è®¾ç½®
permissions:
  contents: write  # å…è®¸åˆ›å»ºrelease

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Run Unit Tests
      run: ./gradlew testDebugUnitTest --stacktrace
      continue-on-error: true

    - name: Generate Test Report
      run: ./gradlew jacocoTestDebugUnitTestReport
      continue-on-error: true



    # å¯é€‰ï¼šå¦‚æœä½ è®¾ç½®äº†Codecov tokenï¼Œå¯ä»¥å–æ¶ˆæ³¨é‡Šä¸‹é¢çš„æ­¥éª¤
    # - name: Upload Report to Codecov
    #   uses: codecov/codecov-action@v3
    #   with:
    #     token: ${{ secrets.CODECOV_TOKEN }}
    #     file: ./app/build/reports/jacoco/jacocoTestDebugUnitTestReport/jacocoTestDebugUnitTestReport.xml
    #     flags: unittests

  # GitHub Release Job - åªåœ¨æ¨é€vå¼€å¤´çš„tagæ—¶è¿è¡Œ
  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build-and-test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Check Signing Secrets
      id: check_secrets
      run: |
        if [ -n "${{ secrets.KEY_JKS }}" ] && [ -n "${{ secrets.ANDROID_STORE_PASSWORD }}" ] && [ -n "${{ secrets.ALIAS }}" ] && [ -n "${{ secrets.ANDROID_KEY_PASSWORD }}" ]; then
          echo "âœ… æ‰€æœ‰ç­¾åå¯†é’¥å·²é…ç½®ï¼Œå°†ä½¿ç”¨æä¾›çš„å¯†é’¥æ„å»ºç­¾åAPK"
          echo "SIGNING_MODE=provided" >> $GITHUB_OUTPUT
        else
          echo "âš ï¸ ç­¾åå¯†é’¥æœªå®Œæ•´é…ç½®ï¼Œå°†ä½¿ç”¨ä¸´æ—¶æµ‹è¯•å¯†é’¥æ„å»ºAPK"
          echo "ç¼ºå¤±çš„secrets:"
          [ -z "${{ secrets.KEY_JKS }}" ] && echo "  - KEY_JKS"
          [ -z "${{ secrets.ANDROID_STORE_PASSWORD }}" ] && echo "  - ANDROID_STORE_PASSWORD"
          [ -z "${{ secrets.ALIAS }}" ] && echo "  - ALIAS"
          [ -z "${{ secrets.ANDROID_KEY_PASSWORD }}" ] && echo "  - ANDROID_KEY_PASSWORD"
          echo "SIGNING_MODE=temporary" >> $GITHUB_OUTPUT
        fi

    - name: Setup Android Keystore
      run: |
        # æ£€æŸ¥æ˜¯å¦æœ‰å®Œæ•´çš„ç­¾åé…ç½®
        if [ -n "${{ secrets.KEY_JKS }}" ] && [ -n "${{ secrets.ANDROID_STORE_PASSWORD }}" ] && [ -n "${{ secrets.ALIAS }}" ] && [ -n "${{ secrets.ANDROID_KEY_PASSWORD }}" ]; then
          echo "ğŸ”‘ ä½¿ç”¨æä¾›çš„å¯†é’¥æ–‡ä»¶..."
          echo "${{ secrets.KEY_JKS }}" | base64 -d > keystore.jks
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          echo "KEYSTORE_FILE=$(pwd)/keystore.jks" >> $GITHUB_ENV
          echo "STORE_PASSWORD=${{ secrets.ANDROID_STORE_PASSWORD }}" >> $GITHUB_ENV
          echo "KEY_ALIAS=${{ secrets.ALIAS }}" >> $GITHUB_ENV
          echo "KEY_PASSWORD=${{ secrets.ANDROID_KEY_PASSWORD }}" >> $GITHUB_ENV
          echo "SIGNING_TYPE=provided" >> $GITHUB_ENV
          
        else
          echo "ğŸ”‘ åˆ›å»ºä¸´æ—¶æµ‹è¯•å¯†é’¥æ–‡ä»¶..."
          # åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„æµ‹è¯•å¯†é’¥
          keytool -genkey -v -keystore keystore.jks \
            -alias android-test-key \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -storepass android -keypass android \
            -dname "CN=Test, OU=Test, O=Test, L=Test, S=Test, C=US"
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          echo "KEYSTORE_FILE=$(pwd)/keystore.jks" >> $GITHUB_ENV
          echo "STORE_PASSWORD=android" >> $GITHUB_ENV
          echo "KEY_ALIAS=android-test-key" >> $GITHUB_ENV
          echo "KEY_PASSWORD=android" >> $GITHUB_ENV
          echo "SIGNING_TYPE=temporary" >> $GITHUB_ENV
        fi
        
        echo "ğŸ” æ£€æŸ¥å¯†é’¥æ–‡ä»¶ä¿¡æ¯..."
        ls -la keystore.jks
        
        # éªŒè¯å¯†é’¥æ–‡ä»¶
        echo "ğŸ” éªŒè¯å¯†é’¥æ–‡ä»¶..."
        if keytool -list -keystore keystore.jks -storepass "$STORE_PASSWORD" > keystore_info.txt 2>&1; then
          echo "âœ… å¯†é’¥æ–‡ä»¶éªŒè¯æˆåŠŸ"
          echo "ğŸ“‹ å¯†é’¥æ–‡ä»¶å†…å®¹ï¼š"
          cat keystore_info.txt
          
          # æ£€æŸ¥æŒ‡å®šçš„åˆ«åæ˜¯å¦å­˜åœ¨
          if grep -q "$KEY_ALIAS" keystore_info.txt; then
            echo "âœ… æ‰¾åˆ°æŒ‡å®šçš„å¯†é’¥åˆ«å: $KEY_ALIAS"
          else
            echo "âŒ æœªæ‰¾åˆ°æŒ‡å®šçš„å¯†é’¥åˆ«å: $KEY_ALIAS"
            echo "ğŸ“‹ å¯ç”¨çš„åˆ«åï¼š"
            grep -E "Alias name:" keystore_info.txt || echo "æ— æ³•è§£æåˆ«åä¿¡æ¯"
            
            # å¦‚æœæ˜¯æä¾›çš„å¯†é’¥ä½†åˆ«åä¸åŒ¹é…ï¼Œå°è¯•ä½¿ç”¨ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„åˆ«å
            if [ "$SIGNING_TYPE" = "provided" ]; then
              FIRST_ALIAS=$(grep -E "Alias name:" keystore_info.txt | head -1 | sed 's/.*Alias name: //')
              if [ -n "$FIRST_ALIAS" ]; then
                echo "ğŸ”„ å°è¯•ä½¿ç”¨ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„åˆ«å: $FIRST_ALIAS"
                echo "KEY_ALIAS=$FIRST_ALIAS" >> $GITHUB_ENV
              fi
            fi
          fi
        else
          echo "âŒ å¯†é’¥æ–‡ä»¶éªŒè¯å¤±è´¥"
          cat keystore_info.txt
          echo "ğŸ”„ é‡æ–°åˆ›å»ºä¸´æ—¶æµ‹è¯•å¯†é’¥..."
          rm -f keystore.jks
          keytool -genkey -v -keystore keystore.jks \
            -alias android-test-key \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -storepass android -keypass android \
            -dname "CN=Test, OU=Test, O=Test, L=Test, S=Test, C=US"
          
          # é‡æ–°è®¾ç½®ä¸ºæµ‹è¯•å¯†é’¥ç¯å¢ƒå˜é‡
          echo "KEYSTORE_FILE=$(pwd)/keystore.jks" >> $GITHUB_ENV
          echo "STORE_PASSWORD=android" >> $GITHUB_ENV
          echo "KEY_ALIAS=android-test-key" >> $GITHUB_ENV
          echo "KEY_PASSWORD=android" >> $GITHUB_ENV
          echo "SIGNING_TYPE=temporary" >> $GITHUB_ENV
        fi
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm -f keystore_info.txt

    - name: Build Signed Release APK
      run: |
        echo "ğŸ”¨ å¼€å§‹æ„å»ºç­¾åAPK..."
        
        echo "ğŸ”‘ ä½¿ç”¨çš„ç­¾åé…ç½®:"
        echo "  - ç­¾åç±»å‹: $SIGNING_TYPE"
        echo "  - å¯†é’¥æ–‡ä»¶: $KEYSTORE_FILE"
        echo "  - å¯†é’¥åˆ«å: $KEY_ALIAS"
        echo "  - å­˜å‚¨åº“å¯†ç : [å·²è®¾ç½®]"
        echo "  - å¯†é’¥å¯†ç : [å·²è®¾ç½®]"
        
        # éªŒè¯å¯†é’¥æ–‡ä»¶å­˜åœ¨
        if [ ! -f "$KEYSTORE_FILE" ]; then
          echo "âŒ å¯†é’¥æ–‡ä»¶ä¸å­˜åœ¨: $KEYSTORE_FILE"
          exit 1
        fi
        
        # æœ€åéªŒè¯å¯†é’¥é…ç½®
        echo "ğŸ” æœ€ç»ˆéªŒè¯å¯†é’¥é…ç½®..."
        if keytool -list -keystore "$KEYSTORE_FILE" -storepass "$STORE_PASSWORD" -alias "$KEY_ALIAS" > /dev/null 2>&1; then
          echo "âœ… å¯†é’¥é…ç½®éªŒè¯æˆåŠŸ"
        else
          echo "âŒ å¯†é’¥é…ç½®éªŒè¯å¤±è´¥"
          echo "ğŸ“‹ é‡æ–°åˆ—å‡ºå¯†é’¥æ–‡ä»¶å†…å®¹ï¼š"
          keytool -list -keystore "$KEYSTORE_FILE" -storepass "$STORE_PASSWORD" 2>&1 || echo "æ— æ³•åˆ—å‡ºå¯†é’¥å†…å®¹"
          exit 1
        fi
        
        echo "ğŸš€ å¼€å§‹æ„å»º..."
        ./gradlew assembleRelease -x test \
          -Pandroid.injected.signing.store.file="$KEYSTORE_FILE" \
          -Pandroid.injected.signing.store.password="$STORE_PASSWORD" \
          -Pandroid.injected.signing.key.alias="$KEY_ALIAS" \
          -Pandroid.injected.signing.key.password="$KEY_PASSWORD"
        echo "âœ… ç­¾åAPKæ„å»ºå®Œæˆ"

    - name: Get tag name
      id: tag_name
      run: echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Find and rename APK file
      run: |
        echo "Listing build output directories:"
        find . -name "*.apk" -type f 2>/dev/null || echo "No APK files found"
        ls -la app/build/outputs/apk/release/ || echo "Release directory not found"
        
        # Find the actual APK file
        APK_FILE=$(find app/build/outputs/apk/release/ -name "*.apk" | head -1)
        if [ -f "$APK_FILE" ]; then
          echo "Found APK: $APK_FILE"
          cp "$APK_FILE" AndroidProxyToggle.apk
        else
          echo "No APK file found in release directory"
          exit 1
        fi

    - name: Create Release and Upload APK
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag_name.outputs.TAG_NAME }}
        name: Release ${{ steps.tag_name.outputs.TAG_NAME }}
        body: |
          ğŸš€ Android Proxy Toggle ${{ steps.tag_name.outputs.TAG_NAME }}
          
          ## ğŸ“± ä¸‹è½½APK
          è¯·ä¸‹è½½ä¸‹æ–¹çš„APKæ–‡ä»¶è¿›è¡Œå®‰è£…
          
          ## ğŸ” APKçŠ¶æ€
          ${{ env.SIGNING_TYPE == 'provided' && 'âœ… **æ­£å¼ç­¾åAPK** - ä½¿ç”¨é…ç½®çš„ç”Ÿäº§å¯†é’¥ç­¾åï¼Œå¯ç›´æ¥å®‰è£…ä½¿ç”¨' || 'âš ï¸ **æµ‹è¯•ç­¾åAPK** - ä½¿ç”¨ä¸´æ—¶æµ‹è¯•å¯†é’¥ç­¾åï¼Œä»…ä¾›æµ‹è¯•ä½¿ç”¨' }}
          
          ## ğŸ”„ æ›´æ–°å†…å®¹
          - æ›´æ–°åˆ°ç‰ˆæœ¬ ${{ steps.tag_name.outputs.TAG_NAME }}
          
          ## ğŸ“ è¯´æ˜
          è¿™æ˜¯ä¸€ä¸ªAndroidä»£ç†åˆ‡æ¢åº”ç”¨çš„å‘å¸ƒç‰ˆæœ¬
        draft: false
        prerelease: false
        files: |
          AndroidProxyToggle.apk

    - name: Cleanup Keystore
      run: |
        if [ -f "keystore.jks" ]; then
          rm -f keystore.jks
          echo "ğŸ§¹ å¯†é’¥æ–‡ä»¶å·²æ¸…ç†"
        fi
      if: always()
